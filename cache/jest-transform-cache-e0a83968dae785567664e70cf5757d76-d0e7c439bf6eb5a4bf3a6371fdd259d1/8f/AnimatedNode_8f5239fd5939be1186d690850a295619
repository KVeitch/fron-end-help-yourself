0771774f553496ef2896da0db51a1fad
var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _ReanimatedModule = _interopRequireDefault(require("../ReanimatedModule"));

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var UPDATED_NODES = [];
var loopID = 1;
var propUpdatesEnqueued = null;

function sanitizeConfig(config) {
  for (var key in config) {
    var value = config[key];

    if (value instanceof AnimatedNode) {
      config[key] = value.__nodeID;
    }
  }

  return config;
}

function runPropUpdates() {
  var visitedNodes = new Set();

  var findAndUpdateNodes = function findAndUpdateNodes(node) {
    if (!node) {
      console.warn('findAndUpdateNodes was passed a nullish node');
      return;
    }

    if (visitedNodes.has(node)) {
      return;
    } else {
      visitedNodes.add(node);
    }

    if (typeof node.update === 'function') {
      node.update();
    } else {
      var nodes = node.__getChildren();

      if (nodes) {
        for (var i = 0, l = nodes.length; i < l; i++) {
          findAndUpdateNodes(nodes[i]);
        }
      }
    }
  };

  for (var i = 0; i < UPDATED_NODES.length; i++) {
    var node = UPDATED_NODES[i];
    findAndUpdateNodes(node);
  }

  UPDATED_NODES.length = 0;
  propUpdatesEnqueued = null;
  loopID += 1;
}

var nodeCount = 0;

var AnimatedNode = function () {
  function AnimatedNode(nodeConfig, inputNodes) {
    (0, _classCallCheck2.default)(this, AnimatedNode);
    this.__lastLoopID = 0;
    this.__memoizedValue = null;
    this.__children = [];
    this.__nodeID = ++nodeCount;
    this.__nodeConfig = sanitizeConfig(nodeConfig);
    this.__initialized = false;
    this.__inputNodes = inputNodes && inputNodes.filter(function (node) {
      return node instanceof AnimatedNode;
    });
  }

  (0, _createClass2.default)(AnimatedNode, [{
    key: "__attach",
    value: function __attach() {
      this.__nativeInitialize();

      var nodes = this.__inputNodes;

      if (nodes) {
        for (var i = 0, l = nodes.length; i < l; i++) {
          nodes[i].__addChild(this);
        }
      }
    }
  }, {
    key: "__detach",
    value: function __detach() {
      var nodes = this.__inputNodes;

      if (nodes) {
        for (var i = 0, l = nodes.length; i < l; i++) {
          nodes[i].__removeChild(this);
        }
      }

      this.__nativeTearDown();
    }
  }, {
    key: "__getValue",
    value: function __getValue() {
      if (this.__lastLoopID < loopID) {
        this.__lastLoopID = loopID;
        return this.__memoizedValue = this.__onEvaluate();
      }

      return this.__memoizedValue;
    }
  }, {
    key: "__forceUpdateCache",
    value: function __forceUpdateCache(newValue) {
      this.__memoizedValue = newValue;

      this.__markUpdated();
    }
  }, {
    key: "__dangerouslyRescheduleEvaluate",
    value: function __dangerouslyRescheduleEvaluate() {
      this.__lastLoopID = 0;

      this.__markUpdated();
    }
  }, {
    key: "__markUpdated",
    value: function __markUpdated() {
      UPDATED_NODES.push(this);

      if (!propUpdatesEnqueued) {
        propUpdatesEnqueued = setImmediate(runPropUpdates);
      }
    }
  }, {
    key: "__nativeInitialize",
    value: function __nativeInitialize() {
      if (!this.__initialized) {
        _ReanimatedModule.default.createNode(this.__nodeID, _objectSpread({}, this.__nodeConfig));

        this.__initialized = true;
      }
    }
  }, {
    key: "__nativeTearDown",
    value: function __nativeTearDown() {
      if (this.__initialized) {
        _ReanimatedModule.default.dropNode(this.__nodeID);

        this.__initialized = false;
      }
    }
  }, {
    key: "isNativelyInitialized",
    value: function isNativelyInitialized() {
      return this.__initialized;
    }
  }, {
    key: "__onEvaluate",
    value: function __onEvaluate() {
      throw new Error('Missing implementation of onEvaluate');
    }
  }, {
    key: "__getProps",
    value: function __getProps() {
      return this.__getValue();
    }
  }, {
    key: "__getChildren",
    value: function __getChildren() {
      return this.__children;
    }
  }, {
    key: "__addChild",
    value: function __addChild(child) {
      if (this.__children.length === 0) {
        this.__attach();
      }

      this.__children.push(child);

      child.__nativeInitialize();

      if (_ReanimatedModule.default.connectNodes) {
        _ReanimatedModule.default.connectNodes(this.__nodeID, child.__nodeID);
      } else {
        this.__dangerouslyRescheduleEvaluate();
      }
    }
  }, {
    key: "__removeChild",
    value: function __removeChild(child) {
      var index = this.__children.indexOf(child);

      if (index === -1) {
        console.warn("Trying to remove a child that doesn't exist");
        return;
      }

      _ReanimatedModule.default.disconnectNodes(this.__nodeID, child.__nodeID);

      this.__children.splice(index, 1);

      if (this.__children.length === 0) {
        this.__detach();
      }
    }
  }, {
    key: "_connectAnimatedView",
    value: function _connectAnimatedView(nativeViewTag) {
      if (_ReanimatedModule.default.connectNodeToView) {
        _ReanimatedModule.default.connectNodeToView(this.__nodeID, nativeViewTag);
      } else {
        this.__dangerouslyRescheduleEvaluate();
      }
    }
  }, {
    key: "_disconnectAnimatedView",
    value: function _disconnectAnimatedView(nativeViewTag) {
      _ReanimatedModule.default.disconnectNodeFromView(this.__nodeID, nativeViewTag);
    }
  }]);
  return AnimatedNode;
}();

exports.default = AnimatedNode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkFuaW1hdGVkTm9kZS5qcyJdLCJuYW1lcyI6WyJVUERBVEVEX05PREVTIiwibG9vcElEIiwicHJvcFVwZGF0ZXNFbnF1ZXVlZCIsInNhbml0aXplQ29uZmlnIiwiY29uZmlnIiwia2V5IiwidmFsdWUiLCJBbmltYXRlZE5vZGUiLCJfX25vZGVJRCIsInJ1blByb3BVcGRhdGVzIiwidmlzaXRlZE5vZGVzIiwiU2V0IiwiZmluZEFuZFVwZGF0ZU5vZGVzIiwibm9kZSIsImNvbnNvbGUiLCJ3YXJuIiwiaGFzIiwiYWRkIiwidXBkYXRlIiwibm9kZXMiLCJfX2dldENoaWxkcmVuIiwiaSIsImwiLCJsZW5ndGgiLCJub2RlQ291bnQiLCJub2RlQ29uZmlnIiwiaW5wdXROb2RlcyIsIl9fbGFzdExvb3BJRCIsIl9fbWVtb2l6ZWRWYWx1ZSIsIl9fY2hpbGRyZW4iLCJfX25vZGVDb25maWciLCJfX2luaXRpYWxpemVkIiwiX19pbnB1dE5vZGVzIiwiZmlsdGVyIiwiX19uYXRpdmVJbml0aWFsaXplIiwiX19hZGRDaGlsZCIsIl9fcmVtb3ZlQ2hpbGQiLCJfX25hdGl2ZVRlYXJEb3duIiwiX19vbkV2YWx1YXRlIiwibmV3VmFsdWUiLCJfX21hcmtVcGRhdGVkIiwicHVzaCIsInNldEltbWVkaWF0ZSIsIlJlYW5pbWF0ZWRNb2R1bGUiLCJjcmVhdGVOb2RlIiwiZHJvcE5vZGUiLCJFcnJvciIsIl9fZ2V0VmFsdWUiLCJjaGlsZCIsIl9fYXR0YWNoIiwiY29ubmVjdE5vZGVzIiwiX19kYW5nZXJvdXNseVJlc2NoZWR1bGVFdmFsdWF0ZSIsImluZGV4IiwiaW5kZXhPZiIsImRpc2Nvbm5lY3ROb2RlcyIsInNwbGljZSIsIl9fZGV0YWNoIiwibmF0aXZlVmlld1RhZyIsImNvbm5lY3ROb2RlVG9WaWV3IiwiZGlzY29ubmVjdE5vZGVGcm9tVmlldyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBOzs7Ozs7QUFFQSxJQUFNQSxhQUFhLEdBQUcsRUFBdEI7QUFFQSxJQUFJQyxNQUFNLEdBQUcsQ0FBYjtBQUNBLElBQUlDLG1CQUFtQixHQUFHLElBQTFCOztBQUVBLFNBQVNDLGNBQVQsQ0FBd0JDLE1BQXhCLEVBQWdDO0FBQzlCLE9BQUssSUFBTUMsR0FBWCxJQUFrQkQsTUFBbEIsRUFBMEI7QUFDeEIsUUFBTUUsS0FBSyxHQUFHRixNQUFNLENBQUNDLEdBQUQsQ0FBcEI7O0FBQ0EsUUFBSUMsS0FBSyxZQUFZQyxZQUFyQixFQUFtQztBQUNqQ0gsTUFBQUEsTUFBTSxDQUFDQyxHQUFELENBQU4sR0FBY0MsS0FBSyxDQUFDRSxRQUFwQjtBQUNEO0FBQ0Y7O0FBQ0QsU0FBT0osTUFBUDtBQUNEOztBQUVELFNBQVNLLGNBQVQsR0FBMEI7QUFDeEIsTUFBTUMsWUFBWSxHQUFHLElBQUlDLEdBQUosRUFBckI7O0FBQ0EsTUFBTUMsa0JBQWtCLEdBQUcsU0FBckJBLGtCQUFxQixDQUFBQyxJQUFJLEVBQUk7QUFDakMsUUFBSSxDQUFDQSxJQUFMLEVBQVc7QUFDVEMsTUFBQUEsT0FBTyxDQUFDQyxJQUFSLENBQWEsOENBQWI7QUFDQTtBQUNEOztBQUVELFFBQUlMLFlBQVksQ0FBQ00sR0FBYixDQUFpQkgsSUFBakIsQ0FBSixFQUE0QjtBQUMxQjtBQUNELEtBRkQsTUFFTztBQUNMSCxNQUFBQSxZQUFZLENBQUNPLEdBQWIsQ0FBaUJKLElBQWpCO0FBQ0Q7O0FBQ0QsUUFBSSxPQUFPQSxJQUFJLENBQUNLLE1BQVosS0FBdUIsVUFBM0IsRUFBdUM7QUFDckNMLE1BQUFBLElBQUksQ0FBQ0ssTUFBTDtBQUNELEtBRkQsTUFFTztBQUNMLFVBQU1DLEtBQUssR0FBR04sSUFBSSxDQUFDTyxhQUFMLEVBQWQ7O0FBQ0EsVUFBSUQsS0FBSixFQUFXO0FBQ1QsYUFBSyxJQUFJRSxDQUFDLEdBQUcsQ0FBUixFQUFXQyxDQUFDLEdBQUdILEtBQUssQ0FBQ0ksTUFBMUIsRUFBa0NGLENBQUMsR0FBR0MsQ0FBdEMsRUFBeUNELENBQUMsRUFBMUMsRUFBOEM7QUFDNUNULFVBQUFBLGtCQUFrQixDQUFDTyxLQUFLLENBQUNFLENBQUQsQ0FBTixDQUFsQjtBQUNEO0FBQ0Y7QUFDRjtBQUNGLEdBckJEOztBQXNCQSxPQUFLLElBQUlBLENBQUMsR0FBRyxDQUFiLEVBQWdCQSxDQUFDLEdBQUdyQixhQUFhLENBQUN1QixNQUFsQyxFQUEwQ0YsQ0FBQyxFQUEzQyxFQUErQztBQUM3QyxRQUFNUixJQUFJLEdBQUdiLGFBQWEsQ0FBQ3FCLENBQUQsQ0FBMUI7QUFDQVQsSUFBQUEsa0JBQWtCLENBQUNDLElBQUQsQ0FBbEI7QUFDRDs7QUFDRGIsRUFBQUEsYUFBYSxDQUFDdUIsTUFBZCxHQUF1QixDQUF2QjtBQUNBckIsRUFBQUEsbUJBQW1CLEdBQUcsSUFBdEI7QUFDQUQsRUFBQUEsTUFBTSxJQUFJLENBQVY7QUFDRDs7QUFFRCxJQUFJdUIsU0FBUyxHQUFHLENBQWhCOztJQUVxQmpCLFk7QUFDbkIsd0JBQVlrQixVQUFaLEVBQXdCQyxVQUF4QixFQUFvQztBQUFBO0FBQUEsU0FnQ3BDQyxZQWhDb0MsR0FnQ3JCLENBaENxQjtBQUFBLFNBaUNwQ0MsZUFqQ29DLEdBaUNsQixJQWpDa0I7QUFBQSxTQW1DcENDLFVBbkNvQyxHQW1DdkIsRUFuQ3VCO0FBQ2xDLFNBQUtyQixRQUFMLEdBQWdCLEVBQUVnQixTQUFsQjtBQUNBLFNBQUtNLFlBQUwsR0FBb0IzQixjQUFjLENBQUNzQixVQUFELENBQWxDO0FBQ0EsU0FBS00sYUFBTCxHQUFxQixLQUFyQjtBQUNBLFNBQUtDLFlBQUwsR0FDRU4sVUFBVSxJQUFJQSxVQUFVLENBQUNPLE1BQVgsQ0FBa0IsVUFBQXBCLElBQUk7QUFBQSxhQUFJQSxJQUFJLFlBQVlOLFlBQXBCO0FBQUEsS0FBdEIsQ0FEaEI7QUFFRDs7OzsrQkFFVTtBQUNULFdBQUsyQixrQkFBTDs7QUFFQSxVQUFNZixLQUFLLEdBQUcsS0FBS2EsWUFBbkI7O0FBRUEsVUFBSWIsS0FBSixFQUFXO0FBQ1QsYUFBSyxJQUFJRSxDQUFDLEdBQUcsQ0FBUixFQUFXQyxDQUFDLEdBQUdILEtBQUssQ0FBQ0ksTUFBMUIsRUFBa0NGLENBQUMsR0FBR0MsQ0FBdEMsRUFBeUNELENBQUMsRUFBMUMsRUFBOEM7QUFDNUNGLFVBQUFBLEtBQUssQ0FBQ0UsQ0FBRCxDQUFMLENBQVNjLFVBQVQsQ0FBb0IsSUFBcEI7QUFDRDtBQUNGO0FBQ0Y7OzsrQkFFVTtBQUNULFVBQU1oQixLQUFLLEdBQUcsS0FBS2EsWUFBbkI7O0FBRUEsVUFBSWIsS0FBSixFQUFXO0FBQ1QsYUFBSyxJQUFJRSxDQUFDLEdBQUcsQ0FBUixFQUFXQyxDQUFDLEdBQUdILEtBQUssQ0FBQ0ksTUFBMUIsRUFBa0NGLENBQUMsR0FBR0MsQ0FBdEMsRUFBeUNELENBQUMsRUFBMUMsRUFBOEM7QUFDNUNGLFVBQUFBLEtBQUssQ0FBQ0UsQ0FBRCxDQUFMLENBQVNlLGFBQVQsQ0FBdUIsSUFBdkI7QUFDRDtBQUNGOztBQUVELFdBQUtDLGdCQUFMO0FBQ0Q7OztpQ0FPWTtBQUNYLFVBQUksS0FBS1YsWUFBTCxHQUFvQjFCLE1BQXhCLEVBQWdDO0FBQzlCLGFBQUswQixZQUFMLEdBQW9CMUIsTUFBcEI7QUFDQSxlQUFRLEtBQUsyQixlQUFMLEdBQXVCLEtBQUtVLFlBQUwsRUFBL0I7QUFDRDs7QUFDRCxhQUFPLEtBQUtWLGVBQVo7QUFDRDs7O3VDQUVrQlcsUSxFQUFVO0FBQzNCLFdBQUtYLGVBQUwsR0FBdUJXLFFBQXZCOztBQUNBLFdBQUtDLGFBQUw7QUFDRDs7O3NEQUVpQztBQUNoQyxXQUFLYixZQUFMLEdBQW9CLENBQXBCOztBQUNBLFdBQUthLGFBQUw7QUFDRDs7O29DQUVlO0FBQ2R4QyxNQUFBQSxhQUFhLENBQUN5QyxJQUFkLENBQW1CLElBQW5COztBQUNBLFVBQUksQ0FBQ3ZDLG1CQUFMLEVBQTBCO0FBQ3hCQSxRQUFBQSxtQkFBbUIsR0FBR3dDLFlBQVksQ0FBQ2pDLGNBQUQsQ0FBbEM7QUFDRDtBQUNGOzs7eUNBRW9CO0FBQ25CLFVBQUksQ0FBQyxLQUFLc0IsYUFBVixFQUF5QjtBQUN2Qlksa0NBQWlCQyxVQUFqQixDQUE0QixLQUFLcEMsUUFBakMsb0JBQWdELEtBQUtzQixZQUFyRDs7QUFDQSxhQUFLQyxhQUFMLEdBQXFCLElBQXJCO0FBQ0Q7QUFDRjs7O3VDQUVrQjtBQUNqQixVQUFJLEtBQUtBLGFBQVQsRUFBd0I7QUFDdEJZLGtDQUFpQkUsUUFBakIsQ0FBMEIsS0FBS3JDLFFBQS9COztBQUNBLGFBQUt1QixhQUFMLEdBQXFCLEtBQXJCO0FBQ0Q7QUFDRjs7OzRDQUV1QjtBQUN0QixhQUFPLEtBQUtBLGFBQVo7QUFDRDs7O21DQUVjO0FBQ2IsWUFBTSxJQUFJZSxLQUFKLENBQVUsc0NBQVYsQ0FBTjtBQUNEOzs7aUNBRVk7QUFDWCxhQUFPLEtBQUtDLFVBQUwsRUFBUDtBQUNEOzs7b0NBRWU7QUFDZCxhQUFPLEtBQUtsQixVQUFaO0FBQ0Q7OzsrQkFFVW1CLEssRUFBTztBQUNoQixVQUFJLEtBQUtuQixVQUFMLENBQWdCTixNQUFoQixLQUEyQixDQUEvQixFQUFrQztBQUNoQyxhQUFLMEIsUUFBTDtBQUNEOztBQUNELFdBQUtwQixVQUFMLENBQWdCWSxJQUFoQixDQUFxQk8sS0FBckI7O0FBQ0FBLE1BQUFBLEtBQUssQ0FBQ2Qsa0JBQU47O0FBRUEsVUFBSVMsMEJBQWlCTyxZQUFyQixFQUFtQztBQUNqQ1Asa0NBQWlCTyxZQUFqQixDQUE4QixLQUFLMUMsUUFBbkMsRUFBNkN3QyxLQUFLLENBQUN4QyxRQUFuRDtBQUNELE9BRkQsTUFFTztBQUNMLGFBQUsyQywrQkFBTDtBQUNEO0FBQ0Y7OztrQ0FFYUgsSyxFQUFPO0FBQ25CLFVBQU1JLEtBQUssR0FBRyxLQUFLdkIsVUFBTCxDQUFnQndCLE9BQWhCLENBQXdCTCxLQUF4QixDQUFkOztBQUNBLFVBQUlJLEtBQUssS0FBSyxDQUFDLENBQWYsRUFBa0I7QUFDaEJ0QyxRQUFBQSxPQUFPLENBQUNDLElBQVIsQ0FBYSw2Q0FBYjtBQUNBO0FBQ0Q7O0FBQ0Q0QixnQ0FBaUJXLGVBQWpCLENBQWlDLEtBQUs5QyxRQUF0QyxFQUFnRHdDLEtBQUssQ0FBQ3hDLFFBQXREOztBQUVBLFdBQUtxQixVQUFMLENBQWdCMEIsTUFBaEIsQ0FBdUJILEtBQXZCLEVBQThCLENBQTlCOztBQUNBLFVBQUksS0FBS3ZCLFVBQUwsQ0FBZ0JOLE1BQWhCLEtBQTJCLENBQS9CLEVBQWtDO0FBQ2hDLGFBQUtpQyxRQUFMO0FBQ0Q7QUFDRjs7O3lDQUVvQkMsYSxFQUFlO0FBQ2xDLFVBQUlkLDBCQUFpQmUsaUJBQXJCLEVBQXdDO0FBQ3RDZixrQ0FBaUJlLGlCQUFqQixDQUFtQyxLQUFLbEQsUUFBeEMsRUFBa0RpRCxhQUFsRDtBQUNELE9BRkQsTUFFTztBQUNMLGFBQUtOLCtCQUFMO0FBQ0Q7QUFDRjs7OzRDQUV1Qk0sYSxFQUFlO0FBQ3JDZCxnQ0FBaUJnQixzQkFBakIsQ0FBd0MsS0FBS25ELFFBQTdDLEVBQXVEaUQsYUFBdkQ7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFuaW1hdGVkTW9kdWxlIGZyb20gJy4uL1JlYW5pbWF0ZWRNb2R1bGUnO1xuXG5jb25zdCBVUERBVEVEX05PREVTID0gW107XG5cbmxldCBsb29wSUQgPSAxO1xubGV0IHByb3BVcGRhdGVzRW5xdWV1ZWQgPSBudWxsO1xuXG5mdW5jdGlvbiBzYW5pdGl6ZUNvbmZpZyhjb25maWcpIHtcbiAgZm9yIChjb25zdCBrZXkgaW4gY29uZmlnKSB7XG4gICAgY29uc3QgdmFsdWUgPSBjb25maWdba2V5XTtcbiAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBBbmltYXRlZE5vZGUpIHtcbiAgICAgIGNvbmZpZ1trZXldID0gdmFsdWUuX19ub2RlSUQ7XG4gICAgfVxuICB9XG4gIHJldHVybiBjb25maWc7XG59XG5cbmZ1bmN0aW9uIHJ1blByb3BVcGRhdGVzKCkge1xuICBjb25zdCB2aXNpdGVkTm9kZXMgPSBuZXcgU2V0KCk7XG4gIGNvbnN0IGZpbmRBbmRVcGRhdGVOb2RlcyA9IG5vZGUgPT4ge1xuICAgIGlmICghbm9kZSkge1xuICAgICAgY29uc29sZS53YXJuKCdmaW5kQW5kVXBkYXRlTm9kZXMgd2FzIHBhc3NlZCBhIG51bGxpc2ggbm9kZScpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICh2aXNpdGVkTm9kZXMuaGFzKG5vZGUpKSB7XG4gICAgICByZXR1cm47XG4gICAgfSBlbHNlIHtcbiAgICAgIHZpc2l0ZWROb2Rlcy5hZGQobm9kZSk7XG4gICAgfVxuICAgIGlmICh0eXBlb2Ygbm9kZS51cGRhdGUgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIG5vZGUudXBkYXRlKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IG5vZGVzID0gbm9kZS5fX2dldENoaWxkcmVuKCk7XG4gICAgICBpZiAobm9kZXMpIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDAsIGwgPSBub2Rlcy5sZW5ndGg7IGkgPCBsOyBpKyspIHtcbiAgICAgICAgICBmaW5kQW5kVXBkYXRlTm9kZXMobm9kZXNbaV0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9O1xuICBmb3IgKGxldCBpID0gMDsgaSA8IFVQREFURURfTk9ERVMubGVuZ3RoOyBpKyspIHtcbiAgICBjb25zdCBub2RlID0gVVBEQVRFRF9OT0RFU1tpXTtcbiAgICBmaW5kQW5kVXBkYXRlTm9kZXMobm9kZSk7XG4gIH1cbiAgVVBEQVRFRF9OT0RFUy5sZW5ndGggPSAwOyAvLyBjbGVhciBhcnJheVxuICBwcm9wVXBkYXRlc0VucXVldWVkID0gbnVsbDtcbiAgbG9vcElEICs9IDE7XG59XG5cbmxldCBub2RlQ291bnQgPSAwO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBBbmltYXRlZE5vZGUge1xuICBjb25zdHJ1Y3Rvcihub2RlQ29uZmlnLCBpbnB1dE5vZGVzKSB7XG4gICAgdGhpcy5fX25vZGVJRCA9ICsrbm9kZUNvdW50O1xuICAgIHRoaXMuX19ub2RlQ29uZmlnID0gc2FuaXRpemVDb25maWcobm9kZUNvbmZpZyk7XG4gICAgdGhpcy5fX2luaXRpYWxpemVkID0gZmFsc2U7XG4gICAgdGhpcy5fX2lucHV0Tm9kZXMgPVxuICAgICAgaW5wdXROb2RlcyAmJiBpbnB1dE5vZGVzLmZpbHRlcihub2RlID0+IG5vZGUgaW5zdGFuY2VvZiBBbmltYXRlZE5vZGUpO1xuICB9XG5cbiAgX19hdHRhY2goKSB7XG4gICAgdGhpcy5fX25hdGl2ZUluaXRpYWxpemUoKTtcblxuICAgIGNvbnN0IG5vZGVzID0gdGhpcy5fX2lucHV0Tm9kZXM7XG5cbiAgICBpZiAobm9kZXMpIHtcbiAgICAgIGZvciAobGV0IGkgPSAwLCBsID0gbm9kZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XG4gICAgICAgIG5vZGVzW2ldLl9fYWRkQ2hpbGQodGhpcyk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgX19kZXRhY2goKSB7XG4gICAgY29uc3Qgbm9kZXMgPSB0aGlzLl9faW5wdXROb2RlcztcblxuICAgIGlmIChub2Rlcykge1xuICAgICAgZm9yIChsZXQgaSA9IDAsIGwgPSBub2Rlcy5sZW5ndGg7IGkgPCBsOyBpKyspIHtcbiAgICAgICAgbm9kZXNbaV0uX19yZW1vdmVDaGlsZCh0aGlzKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLl9fbmF0aXZlVGVhckRvd24oKTtcbiAgfVxuXG4gIF9fbGFzdExvb3BJRCA9IDA7XG4gIF9fbWVtb2l6ZWRWYWx1ZSA9IG51bGw7XG5cbiAgX19jaGlsZHJlbiA9IFtdO1xuXG4gIF9fZ2V0VmFsdWUoKSB7XG4gICAgaWYgKHRoaXMuX19sYXN0TG9vcElEIDwgbG9vcElEKSB7XG4gICAgICB0aGlzLl9fbGFzdExvb3BJRCA9IGxvb3BJRDtcbiAgICAgIHJldHVybiAodGhpcy5fX21lbW9pemVkVmFsdWUgPSB0aGlzLl9fb25FdmFsdWF0ZSgpKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX19tZW1vaXplZFZhbHVlO1xuICB9XG5cbiAgX19mb3JjZVVwZGF0ZUNhY2hlKG5ld1ZhbHVlKSB7XG4gICAgdGhpcy5fX21lbW9pemVkVmFsdWUgPSBuZXdWYWx1ZTtcbiAgICB0aGlzLl9fbWFya1VwZGF0ZWQoKTtcbiAgfVxuXG4gIF9fZGFuZ2Vyb3VzbHlSZXNjaGVkdWxlRXZhbHVhdGUoKSB7XG4gICAgdGhpcy5fX2xhc3RMb29wSUQgPSAwO1xuICAgIHRoaXMuX19tYXJrVXBkYXRlZCgpO1xuICB9XG5cbiAgX19tYXJrVXBkYXRlZCgpIHtcbiAgICBVUERBVEVEX05PREVTLnB1c2godGhpcyk7XG4gICAgaWYgKCFwcm9wVXBkYXRlc0VucXVldWVkKSB7XG4gICAgICBwcm9wVXBkYXRlc0VucXVldWVkID0gc2V0SW1tZWRpYXRlKHJ1blByb3BVcGRhdGVzKTtcbiAgICB9XG4gIH1cblxuICBfX25hdGl2ZUluaXRpYWxpemUoKSB7XG4gICAgaWYgKCF0aGlzLl9faW5pdGlhbGl6ZWQpIHtcbiAgICAgIFJlYW5pbWF0ZWRNb2R1bGUuY3JlYXRlTm9kZSh0aGlzLl9fbm9kZUlELCB7IC4uLnRoaXMuX19ub2RlQ29uZmlnIH0pO1xuICAgICAgdGhpcy5fX2luaXRpYWxpemVkID0gdHJ1ZTtcbiAgICB9XG4gIH1cblxuICBfX25hdGl2ZVRlYXJEb3duKCkge1xuICAgIGlmICh0aGlzLl9faW5pdGlhbGl6ZWQpIHtcbiAgICAgIFJlYW5pbWF0ZWRNb2R1bGUuZHJvcE5vZGUodGhpcy5fX25vZGVJRCk7XG4gICAgICB0aGlzLl9faW5pdGlhbGl6ZWQgPSBmYWxzZTtcbiAgICB9XG4gIH1cblxuICBpc05hdGl2ZWx5SW5pdGlhbGl6ZWQoKSB7XG4gICAgcmV0dXJuIHRoaXMuX19pbml0aWFsaXplZDtcbiAgfVxuXG4gIF9fb25FdmFsdWF0ZSgpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ01pc3NpbmcgaW1wbGVtZW50YXRpb24gb2Ygb25FdmFsdWF0ZScpO1xuICB9XG5cbiAgX19nZXRQcm9wcygpIHtcbiAgICByZXR1cm4gdGhpcy5fX2dldFZhbHVlKCk7XG4gIH1cblxuICBfX2dldENoaWxkcmVuKCkge1xuICAgIHJldHVybiB0aGlzLl9fY2hpbGRyZW47XG4gIH1cblxuICBfX2FkZENoaWxkKGNoaWxkKSB7XG4gICAgaWYgKHRoaXMuX19jaGlsZHJlbi5sZW5ndGggPT09IDApIHtcbiAgICAgIHRoaXMuX19hdHRhY2goKTtcbiAgICB9XG4gICAgdGhpcy5fX2NoaWxkcmVuLnB1c2goY2hpbGQpO1xuICAgIGNoaWxkLl9fbmF0aXZlSW5pdGlhbGl6ZSgpO1xuXG4gICAgaWYgKFJlYW5pbWF0ZWRNb2R1bGUuY29ubmVjdE5vZGVzKSB7XG4gICAgICBSZWFuaW1hdGVkTW9kdWxlLmNvbm5lY3ROb2Rlcyh0aGlzLl9fbm9kZUlELCBjaGlsZC5fX25vZGVJRCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX19kYW5nZXJvdXNseVJlc2NoZWR1bGVFdmFsdWF0ZSgpO1xuICAgIH1cbiAgfVxuXG4gIF9fcmVtb3ZlQ2hpbGQoY2hpbGQpIHtcbiAgICBjb25zdCBpbmRleCA9IHRoaXMuX19jaGlsZHJlbi5pbmRleE9mKGNoaWxkKTtcbiAgICBpZiAoaW5kZXggPT09IC0xKSB7XG4gICAgICBjb25zb2xlLndhcm4oXCJUcnlpbmcgdG8gcmVtb3ZlIGEgY2hpbGQgdGhhdCBkb2Vzbid0IGV4aXN0XCIpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBSZWFuaW1hdGVkTW9kdWxlLmRpc2Nvbm5lY3ROb2Rlcyh0aGlzLl9fbm9kZUlELCBjaGlsZC5fX25vZGVJRCk7XG5cbiAgICB0aGlzLl9fY2hpbGRyZW4uc3BsaWNlKGluZGV4LCAxKTtcbiAgICBpZiAodGhpcy5fX2NoaWxkcmVuLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhpcy5fX2RldGFjaCgpO1xuICAgIH1cbiAgfVxuXG4gIF9jb25uZWN0QW5pbWF0ZWRWaWV3KG5hdGl2ZVZpZXdUYWcpIHtcbiAgICBpZiAoUmVhbmltYXRlZE1vZHVsZS5jb25uZWN0Tm9kZVRvVmlldykge1xuICAgICAgUmVhbmltYXRlZE1vZHVsZS5jb25uZWN0Tm9kZVRvVmlldyh0aGlzLl9fbm9kZUlELCBuYXRpdmVWaWV3VGFnKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fX2Rhbmdlcm91c2x5UmVzY2hlZHVsZUV2YWx1YXRlKCk7XG4gICAgfVxuICB9XG5cbiAgX2Rpc2Nvbm5lY3RBbmltYXRlZFZpZXcobmF0aXZlVmlld1RhZykge1xuICAgIFJlYW5pbWF0ZWRNb2R1bGUuZGlzY29ubmVjdE5vZGVGcm9tVmlldyh0aGlzLl9fbm9kZUlELCBuYXRpdmVWaWV3VGFnKTtcbiAgfVxufVxuIl19